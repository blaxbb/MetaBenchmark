@page "/product/{productId}"
@inject DataService data;
@inject NavigationManager nav;

@using MetaBenchmark.Components
@using MetaBenchmark
@using System.Web
@using MetaBenchmark.Models
@using MetaBenchmark.Services

<ProductDetails product="product" allProducts="allProducts" CurrentBenchmarkType="benchmarkType"/>

@code {
    Product? product;
    List<Product> allProducts;

    [Parameter]
    public string productId { get; set; }

    Benchmark.BenchmarkType benchmarkType;

    protected override async Task OnParametersSetAsync()
    {
        var query = HttpUtility.ParseQueryString(new Uri(nav.Uri).Query);
        var benchTypeQuery = query.Get("bt");


        allProducts = data.AllProducts();
        if (allProducts != null && long.TryParse(productId, out long id))
        {
            product = allProducts.FirstOrDefault(p => p.Id == id);
            if(Enum.TryParse<Benchmark.BenchmarkType>(benchTypeQuery, out var type))
            {
                benchmarkType = type;
            }
            else
            {
                if(product.BenchmarkEntries.Any(b => b.Benchmark.Type == Benchmark.BenchmarkType.FPS_1440P))
                {
                    benchmarkType = Benchmark.BenchmarkType.FPS_1440P;
                }
                else
                {
                    benchmarkType = product?.BenchmarkEntries?.FirstOrDefault()?.Benchmark?.Type ?? Benchmark.BenchmarkType.FPS_1440P;
                }
            }
        }
    }

}
